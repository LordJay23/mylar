<%inherit file="base.html"/>
<%!
    import mylar
    from operator import itemgetter
%>
<%def name="headerIncludes()">
    <div id="subhead_container">
        <div id="subhead_menu">
            <a onclick="self.shutdownQA(this)" class="button btn btn-sm btn-danger" data-toggle="tooltip" data-placement="bottom" title="Terminate the Mylar process - Be careful if you're doing this remotely"><i class="fa fa-power-off"></i> Shutdown</a>
            <a class="button btn btn-sm btn-warning" onclick="self.restartQA(this, '', '')" data-toggle="tooltip" data-placement="bottom" title="Restart Mylar"><i class="fa fa-refresh"></i> Restart</a>
            <a class="button btn btn-sm btn-primary" href="checkForUpdates" data-toggle="tooltip" data-placement="bottom" title="Check for the latest release"><i class="fa fa-check-square-o"></i> Check Version</a>
      </div>
    </div>
</%def>
<%def name="body()">
    <form action="configUpdate" method="post">
        <div role="tab-table" class="hidden">
            <div>
                <ul class="nav nav-tabs" role="tablist" id="configtabs">
                    <li role="presentation" id="1" aria-controls="information"><a role="tab" data-toggle="tab" aria-controls="information" href="#information">Information</a></li>
                    <li role="presentation" id="2" aria-controls="interface"><a role="tab" data-toggle="tab" aria-controls="interface" href="#interface">Web Interface</a></li>
                    <li role="presentation" id="3" aria-controls="download_settings"><a role="tab" data-toggle="tab" aria-controls="download_settings" href="#download_settings">Download Settings</a></li>
                    <li role="presentation" id="4" aria-controls="search_providers"><a role="tab" data-toggle="tab" aria-controls="search_providers" href="#search_providers">Search Providers</a></li>
                    <li role="presentation" id="5" aria-controls="post_processing"><a role="tab" data-toggle="tab" aria-controls="post_processing" href="#post_processing">Quality &amp; Post Processing</a></li>
                    <li role="presentation" id="6" aria-controls="advanced"><a role="tab" data-toggle="tab" aria-controls="advanced" href="#advanced">Advanced Settings</a></li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane" id="information">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                      <fieldset>
                                      <legend>Configuration Options</legend>
                                           <div>
                                                <label><strong>Mylar Version: </strong> ${config['branch']}</br> -- ${config['br_type']}  build ${config['br_version']}.</label></br>
                                                <label><strong>Python Version :</strong> ${config['py_version']}</label></br>
                                                <label><strong>Language :</strong> ${config['lang']}</label></br></br>
                                                <legend>MYLAR PROGRAM OPTIONS</legend>
                                                <label><strong>Mylar Data Directory :</strong>  ${config['data_dir']}</label></br>
                                                <label><strong>Mylar Program Directory :</strong> ${config['prog_dir']}</label></br>
                                                <label><strong>Mylar Cache Directory :</strong> ${config['cache_dir']}</label></br>
                                                <a href="config_dump"><label><strong>Mylar Config File :</strong>${config['config_file']}</label></a></br>

                                           </div>
                                       </fieldset>
                                       <fieldset>
                                           <legend>DONATIONS</legend>
                                             <a name="donate"></a>
                                             <div align="center">
                                                <label><strong>Mylar is free to use,</br>
                                                but you can contribute and support the development</br>
                                                by buying me a coffee (or several)</strong></label></br></br>
                                             </div>
                                             <div style="width: 60%; margin: 0px auto;">
                                                <a id="navDonate" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=EWQADB5AMVRFU" rel="noreferrer" onclick="window.open('http://dereferer.org/?' + this.href); return false;"><img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" alt="[donate]" /></a>
                                                <a href="https://flattr.com/submit/auto?user_id=evilhero&url=https://github.com/evilhero/mylar&title=Mylar%20Donation%description=Supporting&20the%development%20of%20Mylar&language=en_CA&hidden=1&category=software" target="_blank">
                                                   <img src="//api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" align="center">
                                                </a>
                                                <a href="#" onclick="javascript:window.prompt('Please copy/paste my Bitcoin address into your Bitcoin client.', '18eCE9wZxnNiZgE4Cc5pwJMnMjEfhdmH4U');"><img src="interfaces/default/images/bitcoin.png" alt="Bitcoin" height="20" align="center"></a>
                                             </div>
                                       </fieldset>
                                </div>
                                <div class="col-md-6">
                                       <fieldset>
                                          <legend>Bragging Rights</legend>
                                            <div>
                                               <label><strong># of Series you're watching: </strong> ${comicinfo['COUNT_COMICS']}</br></label>
                                               <label><strong># of Issues you're watching: </strong> ${comicinfo['COUNT_ISSUES']}</br></label>
                                               <label><strong># of Issues you actually have: </strong> ${comicinfo['COUNT_HAVES']}</br></label>
                                               <label><strong> ... total HD-space being used: </strong> ${comicinfo['COUNT_SIZE']}</br></label>
                                            </div>
                                       </fieldset>
                                    <fieldset>
                                         <legend>Useful Information</legend>
                                            <div class="row">
                                              <label><strong>Forums</strong></label>
                                                <div><a href="https://forum.mylarcomics.com/" target="_blank">https://forum.mylarcomics.com</a></div>
                                            </div>
                                            <div class="row">
                                              <label><strong>Source</strong></label>
                                                <div><a href="https://github.com/evilhero/mylar/" target="_blank">https://github.com/evilhero/mylar/</a></div>
                                            </div>
                                            <div class="row">
                                              <label><strong>Issues</strong></label>
                                                <div><a href="https://github.com/evilhero/mylar/issues" target="_blank">https://github.com/evilhero/mylar/issues/</a></div>
                                            </div>
                                            <div class="row">
                                              <label><strong>Internet Relay Chat</strong></label>
                                                  <div><a href="irc://irc.freenode.net/#mylar" target="_blank">#mylar on irc.freenode.net</a></div>
                                            </div>
                                    </fieldset>
                                    <fieldset>
                                        <legend>Branch history</legend>
                                            <div>${config['branch_history']}</div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="row">
                                            <label style="font-size:16px;font-weight:bold;">Provider Usage (${config['dltotals']})</label>
                                            <a href="#" onclick="show_stats();"><span style="vertical-align:bottom;text-align:center;float:right;">Show Stats</span></a>
                                        </div>
                                        <div id="stats" style="display:none">
                                        </br>
                                        %for dl in config['dlstats']:
                                            <%
                                                dlline = '%s: %s snatches' % (dl[0], dl[1])
                                                if dl[0] == 'newznab':
                                                    dlline += '<small>  (*erroneous collection data)</small>'
                                            %>
                                            ${dlline}</br>
                                        %endfor
                                        </div>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="interface">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                    <fieldset>
                                        <legend>Basic</legend>
                                        <div class="form-group">
                                            <label for="http_host" class="control-label">HTTP Host</label>
                                            <input class="form-control" id="http_host" type="text" name="http_host" value="${config['http_host']}" size="30">
                                            <small>e.g. localhost or 0.0.0.0</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="http_port" class="control-label">HTTP Port</label>
                                            <input class="form-control" type="text" id="http_port" name="http_port" value="${config['http_port']}" size="10">
                                        </div>
                                        <div class="form-group">
                                            <div class="checkbox">
                                                <input type="checkbox" name="enable_https" id="enable_https" value="1" ${config['enable_https']} />
                                                <label class="control-label" for="enable_https" title="Enable HTTPS for web server for encrypted communication">
                                                    Enable HTTPS
                                                </label>
                                            </div>
                                            <div id="https_options">
                                                <div  class="form-group">
                                                     <label for="https_cert" class="control-label">HTTPS Cert</label>
                                                     <input id="https_cert" class="form-control" type="text" title="the FULL path to the certificate" name="https_cert" value="${config['https_cert']}" size="30">
                                                </div>
                                                <div class="form-groups">
                                                     <label for="https_key" class="control-label">HTTPS Key</label>
                                                     <input id="https_key" type="text" title="the FULL path to the key" name="https_key" value="${config['https_key']}" size="30">
                                                </div>
                                             </div>
                                         </div>
                                         <div class="form-group">
                                             <label for="authentication" class="control-label">Authentication</label>
                                                 <select class="form-control" name="authentication" onchange="authoptions()" id="authentication">
                                                       %for lpe in [0, 1, 2]:
                                                                <%
                                                                        if config['authentication'] == lpe:
                                                                                outputselect = 'selected'
                                                                        else:
                                                                                outputselect = ''
                                                                        if lpe == 2:
                                                                                auth_value = 'Forms (Login Page)'
                                                                        elif lpe == 1:
                                                                                auth_value = 'Basic (Browser Popup)'
                                                                        else:
                                                                                auth_value = 'None'

                                                                %>
                                                           <option value=${lpe} ${outputselect}>${auth_value}</option>
                                                        %endfor
                                                 </select>
                                         </div>
                                         <div id="auth_options">
                                             <div class="form-group">
                                                 <label for="http_username" class="control-label">HTTP Username</label>
                                                 <input id="http_username" class="form-control" type="text" name="http_username" value="${config['http_user']}" size="30">
                                             </div>
                                             <div class="form-group">
                                                 <label for="http_password" class="control-label">HTTP Password</label>
                                                 <input id="http_password" class="form-control" type="password" name="http_password" value="${config['http_pass']| h}" size="30">
                                             </div>
                                        </div>
                                         <div class="checkbox">
                                             <input type="checkbox" id="launch_browser" name="launch_browser" value="1" ${config['launch_browser']} /> <label for="launch_browser" class="control-label">Launch Browser on Startup</label>
                                         </div>

                                         <div class="checkbox">
                                             <input id="syno_fix" type="checkbox" name="syno_fix" value="1" ${config['syno_fix']} /> <label for="syno_fix" class="control-label">Synology Fix</label>
                                             <br/><small>*Use this if experiencing parsing problems*</small>
                                         </div>
                                    </fieldset>
                                    <fieldset>
                                    <legend>Annual Handling</legend>
                                        <div class="form-group">
                                            <small class="heading"><span style="float: left; margin-right: .3em; margin-top: 4px;" class="ui-icon ui-icon-info"></span>Series need to be Refreshed for annuals to appear</small>
                                        </div>
                                        <div class="checkbox">
                                            <input id="annuals_on" type="checkbox" name="annuals_on" value="1" ${config['annuals_on']} /><label for="annuals_on" class="control-label">Enable Series-Annual Integration</label>
                                        </div>
                                         </br><small>Enabled: Annuals are tracked as part of the series it belongs to</small></br>
                                         <small>Disabled: Annuals are tracked independently and will appear on your watchlist as a series</small>
                                    </fieldset>
                                </div>
                                <div class="col-md-6">
                                <fieldset>
                                    <legend>API</legend>
                                    <div class="form-group">
                                       <label for="comicvine_api" class="control=label">ComicVine API Key</label>
                                       <input id="comicvine_api" class="form-control" type="text" name="comicvine_api" value="${config['comicvine_api']}" title="get one for free @ http://api.comicvine.com" size="40">
                                       <small>specify your own CV API key here </small>
                                    </div>

                                    <div class="form-group">
                                        <div class="checkbox">
                                            <input id="api_enabled" type="checkbox" name="api_enabled" value="1" ${config['api_enabled']} /><label for="api_enabled" class="control-label">Enable API</label>
                                        </div>
                                        <div id="apioptions">
                                           <div class="form-group">
                                              <label for="api_key" class="control-label">Mylar API key</label>
                                              <input class="form-control" type="text" name="api_key" id="api_key" value="${config['api_key']}" size="20">
                                              <input class="button btn btn-sm btn-primary" type="button" value="Generate" id="generate_api">
                                              <small>Current API key: <strong>${config['api_key']}</strong></small>
                                          </div>
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset>
                                    <legend>OPDS</legend>
                                    <div class="form-group">
                                        <div class="checkbox">
                                            <input id="opds_enable" type="checkbox" name="opds_enable" value="1" ${config['opds_enable']} /><label class="control-label" for="opds_enable">Enable OPDS</label>
                                        </div>
                                        <div id="opdsoptions">
                                            <div class="checkbox">
                                                <small>Access the OPDS server at http://mylarhost/opds/ - keep in mind your scheme (http or https), your hostname, port, and any http_root you may have set. </small></br>
                                                <input id="opds_authentication" type="checkbox" name="opds_authentication" value="1" ${config['opds_authentication']} /><label for="opds_authentication" class="control-label">OPDS Requires Credentials</label>
                                                <%
                                                     opds_notes = "Require authentication for OPDS.  If checked\nyou will need to provide a username/password.\nThe service user name will work (if set).  Additionally,\nyou can provide a user with only OPDS access below.\nNOTE: If this is not checked, OPDS will be available\nwithout a password."
                                                %>
                                                <a href="#" title="${opds_notes}"><img src="interfaces/default/images/info32.png" height="16" alt="" /></a>
                                                <div id="opdscredentials">
                                                     <div class="form-group">
                                                         <label for="opds_username" class="control-label">OPDS Username</label>
                                                         <input class="form-control" id="opds_username" type="text" name="opds_username" value="${config['opds_username']}" size="30">
                                                     </div>

                                                     <div class="form-group">
                                                       <label for="opds_password" class="control-label">OPDS Password</label>
                                                       <input class="form-control" id="opds_password" type="password" name="opds_password" value="${config['opds_password']| h}" size="30">
                                                     </div>
                                                </div>
                                            </div>
                                            <div class="checkbox">
                                                <input id="opds_metainfo" type="checkbox" name="opds_metainfo" value="1" ${config['opds_metainfo']} /><label for="opds_metainfo" class="control-label">OPDS Fetch MetaInfo</label>
                                                </br><small>Warning: Enabling this will slow down issue listing significantly, but will give writer info and book summary</small>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset>
                                    <legend>Interval</legend>
                                    <div class="form-group">
                                        <label class="control-label" for="search_interval">NZB Search Interval</label>
                                        <input id="search_interval" class="form-control" type="text" name="search_interval" value="${config['search_interval']}" size="4">mins
                                        <div class="checkbox">
                                            <input id="nzb_startup_search" type="checkbox" name="nzb_startup_search" value="1" ${config['nzb_startup_search']} /><label for="nzb_startup_search" class="control-label">NZB Search on startup</label>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="search_delay">Search delay</label>
                                            <input id="search_delay" class="form-control" type="text" name="search_delay" value="${config['search_delay']}" size="4" />mins
                                            <small>The amount of time to wait between each search request (minimum is 1 min)</small>
                                        </div>
                                    </div>
                                </fieldset>
	                            <fieldset>
                                    <legend>Comic Location</legend>
                                    <div>
                                        <small class="heading"><span style="float: left; margin-right: .3em; margin-top: 4px;" class="ui-icon ui-icon-info"></span>Automatic folder creation happens BENEATH this path</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label" for="destination_dir">Comic Location Path</label>
                                        <input class="form-control" id="destination_dir" type="text" name="destination_dir" value="${config['destination_dir']}" size="50">
                                        <small>Where do you store your comics?<br/> (or where do you want me to store them)</small>
                                        <small>e.g. /Users/name/Comics or /Volumes/share/comics</small>
                                    </div>
                                </fieldset>
                                <fieldset>
                                    <legend>Permissions</legend>
                                    <div class="checkbox">
                                       <input type="checkbox" name="enforce_perms" id="enforce_perms" value="1" ${config['enforce_perms']} /><label for="enforce_perms" class="control-label">Enforce Permissions</label>
                                    </div>
                                    <div id="perms_options">
                                        <div class="form-group">
                                            <label for="chmod_dir" class="control-label">Directory CHMOD</label>
                                            <input class="form-control" id="chmod_dir" type="text" name="chmod_dir" value="${config['chmod_dir']}" size="50">
                                            <small>Permissions on created/moved directories</small>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="chmod_file">File CHMOD</label>
                                            <input class="form-control" id="chmod_file" type="text" name="chmod_file" value="${config['chmod_file']}" size="50">
                                            <small>Permissions on created/moved files</small>
                                        </div>
                                        %if 'windows' not in mylar.OS_DETECT.lower():
                                            <div class="form-group">
                                                <label class="control-label" for="chowner">Owner</label>
                                                <input class="form-control" id="chowner" type="text" name="chowner" value="${config['chowner']}" size="50">
                                                <small>Set Ownership of files/directories (name OR uid)</small>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label" for="chgroup">Group</label>
                                                <input class="form-control" id="chgroup" type="text" name="chgroup" value="${config['chgroup']}" size="50">
                                                <small>Set Group Ownership of files/directories (name OR gid)</small>
                                            </div>
                                        %endif
                                    </div>
                                </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="modules">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="defaults">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="tfew">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="msf">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="swgoh">
                        <div class="configtable">
                            <div class="row">
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table_wrapper_button">
                <input type="submit" value="Save changes" id="add" class="btn btn-primary">
            </div>
            <p>&nbsp;</p>
        </div>
    </form>
</%def>
<%def name="javascriptIncludes()">
        <script>
        function authoptions()
        {
            var answer = document.getElementById("authentication");
            if(answer[answer.selectedIndex].value == 2 || answer[answer.selectedIndex].value == 1){
                document.getElementById("auth_options").style.display = "initial";
            } else {
                document.getElementById("auth_options").style.display = "none";
            }
        }
        function show_stats()
        {
            var x = document.getElementById("stats");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }
        </script>
  <script type="text/javascript">
    function initThisPage()

    {
        "use strict";

        if ($("#enable_https").is(":checked"))
            {
                    $("#https_options").show();
            }
            else
            {
                    $("#https_options").hide();
            }

        $("#enable_https").click(function(){
                if ($("#enable_https").is(":checked"))
                {
                        $("#https_options").slideDown();
                }
                else
                {
                        $("#https_options").slideUp();
                }
        });

        if ($("#api_enabled").is(":checked"))
            {
                    $("#apioptions").show();
            }
            else
            {
                    $("#apioptions").hide();
            }

        $("#api_enabled").click(function(){
                if ($("#api_enabled").is(":checked"))
                {
                        $("#apioptions").slideDown();
                }
                else
                {
                        $("#api_ptions").slideUp();
                }
        });
        if ($("#opds_enable").is(":checked"))
                {
                        $("#opdsoptions").show();
                }
                else
                {
                        $("#opdsoptions").hide();
                }
        $("#opds_enable").click(function(){
                if ($("#opds_enable").is(":checked"))
                {
                        $("#opdsoptions").slideDown();
                }
                else
                {
                        $("#opdsoptions").slideUp();
                }
        });

        $('#generate_api').click(function () {
            $.get("generateAPI",
                function (data) {
                if (data.error != undefined) {
                    alert(data.error);
                    return;
                }
                $('#api_key').val(data);
                });

        });

        if ($("#enforce_perms").is(":checked"))
                {
                    $("#perms_options").show();
                }
        else
                {
                    $("#perms_options").hide();
                }
        $("#enforce_perms").click(function () {
                if ($("#enforce_perms").is(":checked"))
                {
                    $("#perms_options").slideDown();
                }
                else
                {
                    $("#perms_options").slideUp();
                }
        });

        $('#show_Jobs').on('click', function(e) {
            $.get('show_Jobs', function(data) {
                bootbox.dialog({
                    title: 'Jobs Status',
                    message: '<pre>'+data+'</pre>',
                    buttons: {
                        primary: {
                            label: "Close",
                            className: 'btn-primary'
                        }
                    }
                });
            });
        });

        $('#stop_Jobs').on('click', function(e) {
            $.get('stop_Jobs', function(data) {
                bootbox.dialog({
                    title: 'Stop Jobs',
                    message: '<pre>'+data+'</pre>',
                    buttons: {
                        primary: {
                            label: "Close",
                            className: 'btn-primary'
                        }
                    }
                });
            });
        });

        $('#restart_Jobs').on('click', function(e) {
            $.get('restart_Jobs', function(data) {
                bootbox.dialog({
                    title: 'Restarted Jobs',
                    message: '<pre>'+data+'</pre>',
                    buttons: {
                        primary: {
                            label: "Close",
                            className: 'btn-primary'
                        }
                    }
                });
            });
        });


        // when the page first loads, hide all tab headers and panels
        $("li[role='presentation']").attr("aria-selected", "false");
        $("li[role='presentation']").removeClass('active');
        $("div[role='tabpanel']").attr("aria-hidden", "true");
        $("div[role='tabpanel']").removeClass('active');
        // which one do we want to show
        var tabnum = $("#current_tab").val();
        var tabid = $("#" + tabnum);
        var tabpanel = tabid.attr('aria-controls');
        var tabpanelid = $("#" + tabpanel);
        // show the tab header and panel we want
        tabpanelid.attr("aria-hidden", "false");
        tabpanelid.addClass('active');
        tabid.attr("aria-selected", "true");
        tabid.addClass('active');
        $("div[role='tab-table']").removeClass('hidden');

        // when a tab is clicked
        $("li[role='presentation']").click(function(){
            var tabnum = $(this).attr('id');    // store current tab for python
            $("#current_tab").val(tabnum);
        });


    } // End Init

    $(document).ready(function() {
        initThisPage();
    });
  </script>
</%def>